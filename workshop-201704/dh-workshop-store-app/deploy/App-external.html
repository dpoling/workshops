<!DOCTYPE html>
<html>
<head>
    <title>dh-workshop-store-app</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{myQuery:"",notStartedStates:["","Definition and Design","Definition","Feature Walkthrough","Prioritization"],inProgressStates:["Development","Testing"],doneStates:["Done","Acceptance","Pilot","Gereral Availability - Beta","General Availability","Archive"],model:"PortfolioItem/Feature"}},items:[{xtype:"container",itemId:"chartBox"},{xtype:"container",itemId:"gridBox"}],launch:function(){var model=this.getSetting("model");this.createStore(model),this.buildGridboard(model)},buildGridboard:function(model,chartFilters){var context=this.getContext();this.down("#gridBox").removeAll();var filters=this.getFilters(chartFilters);Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[model],enableHierarchy:!0,filters:filters}).then({success:function(store){store.load(),this.down("#gridBox").add({xtype:"rallygridboard",context:context,modelNames:[model],toggleState:"grid",plugins:[{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[model],stateful:!0,stateId:context.getScopedStateId("columns-example")}],gridConfig:{store:store,columnCfgs:["FormattedID","Name","State"]},height:400})},failure:function(){Rally.ui.notify.Notifier.showError({message:"Store load failed"})},scope:this})},updateFilters:function(filters){var model=this.getSetting("model");this.buildGridboard(model,filters)},getNotStartedStates:function(){return this.getSetting("notStartedStates")},getInProgressStates:function(){return this.getSetting("inProgressStates")},getDoneStates:function(){return this.getSetting("doneStates")},addChart:function(records){var stateHash={},dataHash={};dataHash["Not Started"]=0,dataHash["In Progress"]=0,dataHash.Done=0;for(var i=0;i<records.length;i++){var state=records[i].get("State"),stateName=state&&state.Name||"";Ext.Array.contains(this.getNotStartedStates(),stateName)&&dataHash["Not Started"]++,Ext.Array.contains(this.getInProgressStates(),stateName)&&dataHash["In Progress"]++,Ext.Array.contains(this.getDoneStates(),stateName)&&dataHash.Done++,stateHash[stateName]||(stateHash[stateName]=0),stateHash[stateName]++}var data=[];Ext.Object.each(dataHash,function(key,val){data.push([key,val])});var chartData={series:[{type:"pie",name:"# Features",innerSize:"50%",data:data}]},thisApp=this;this.down("#chartBox").add({xtype:"rallychart",chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:0,plotShadow:!1},title:{text:this.getTitle(records),align:"center",verticalAlign:"middle",useHTML:!0,y:40},tooltip:{pointFormat:"{series.name}: {point.y}<br/><b>{point.percentage:.1f}%</b>"},plotOptions:{series:{point:{events:{click:function(event){var pointName=event&&event.currentTarget&&event.currentTarget.name||null;if(pointName){var getStates=Ext.bind(thisApp.getStatesForPointName,thisApp),states=getStates(pointName);if(states&&states.length>0){var filters=Ext.Array.map(states,function(s){return{property:"State.Name",value:s}});filters=filters.length>1?Rally.data.wsapi.Filter.or(filters):Ext.create("Rally.data.wsapi.Filter",filters[0]);var scopedUpdateFilter=Ext.bind(thisApp.updateFilters,thisApp);scopedUpdateFilter(filters)}}}}}},pie:{dataLabels:{enabled:!0,distance:-50,style:{fontWeight:"bold",color:"white"}},startAngle:-90,endAngle:90,center:["50%","75%"]}}},chartData:chartData})},getStatesForPointName:function(pointName){return"Not Started"===pointName?this.getNotStartedStates():"In Progress"===pointName?this.getInProgressStates():"Done"===pointName?this.getDoneStates():[]},getTitle:function(records){return'<div class="big-text">'+records.length+"</div><b>Features</b>"},addGrid:function(){var model=this.getSetting("model");this.add({xtype:"rallygrid",storeConfig:{model:model,fetch:["FormattedID","Name","Release","ReleaseDate","Owner","UserName","UserStories:summary[ScheduleState]"],filters:this.getFilters(),pageSize:2e3},columnCfgs:["FormattedID","Name",{dataIndex:"Release",text:"Release Date",renderer:function(value){if(value&&value.ReleaseDate){var date=Rally.util.DateTime.fromIsoString(value.ReleaseDate);return Ext.String.format("<b>{0}</b> ({1})",value.Name,Rally.util.DateTime.format(date,"Y-m-d"))}return"-- No Release Date --"}},{dataIndex:"Summary",text:"Schedule State Breakdown",renderer:function(v,m,r){var summary=r.get("Summary");return summary.UserStories&&summary.UserStories.ScheduleState?Ext.String.format("Accepted: {0}<br/>Completed: {1}<br/>In-Progress: {2}<br/>Defined: {3}",summary.UserStories.ScheduleState.Accepted||0,summary.UserStories.ScheduleState.Completed||0,summary.UserStories.ScheduleState["In-Progress"]||0,summary.UserStories.ScheduleState.Defined||0):v}},"PercentDoneByStoryCount"],showPagingToolbar:!1})},getFilters:function(chartFilters){var myQueryString=this.getSetting("myQuery"),queryFilters=null;return myQueryString&&myQueryString.length>0&&(queryFilters=Rally.data.wsapi.Filter.fromQueryString(myQueryString)),chartFilters&&queryFilters?chartFilters.and(queryFilters):chartFilters?chartFilters:queryFilters?queryFilters:[]},createStore:function(model){var thisApp=this,store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["State","Name","FormattedID","Release","ReleaseDate","UserStories:summary[ScheduleState]","PercentDoneByStoryCount"],filters:this.getFilters(),pageSize:2e3,limit:"Infinity"});return store.load({callback:function(records){this.addChart(records)},scope:thisApp}),store},getSettingsFields:function(){return[{xtype:"textareafield",name:"myQuery",width:500,fieldLabel:"Query",labelAlign:"right",validateOnChange:!1,validateOnBlur:!1,validator:function(value){try{value&&value.length&&Rally.data.wsapi.Filter.fromQueryString(value)}catch(e){return Rally.ui.notify.Notifier.showError({message:e.message}),console.log("message",e.message),e.message}return!0}}]}});

            Rally.launchApp('CustomApp', {
                name:"dh-workshop-store-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .big-text{font-size:36px;font-weight:bolder}
    </style>
</head>
<body>
</body>
</html>
